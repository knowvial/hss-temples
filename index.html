<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowvial Interactive Presentation</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2, h3 {
            color: #8b4513;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        .presentation-display {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .slide-image {
            width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .slide-title {
            font-size: 1.5rem;
            color: #8b4513;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .slide-subtitle {
            font-style: italic;
            color: #666;
            margin-bottom: 10px;
        }
        .slide-description {
            line-height: 1.6;
        }
        .key-facts {
            background-color: #f9f5eb;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 8px;
        }
        .btn {
            background-color: #8b4513;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #6d370f;
        }
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .login-container {
            max-width: 400px;
            margin: 80px auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        .waiting-screen {
            text-align: center;
            padding: 40px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-top: 50px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            margin-bottom: 10px;
        }
        .presenter-bar {
            background-color: #8b4513;
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .share-section {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border: 1px solid #ddd;
        }
        .file-selector {
            margin: 15px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .animated-dots::after {
            content: '.';
            animation: dots 1.5s infinite;
        }
        @keyframes dots {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
    </style>
</head>
<body>
    <div class="container" id="container">
        <h1 id="presentation-title">Presentation Tour</h1>
        <div id="content-area">
            <!-- Content will be populated by JavaScript -->
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        // Application variables
        let currentSlideIndex = 0;
        let isPresenterMode = false;
        let sessionId = null;
        let presentationData = null;
        let presentationTitle = "Presentation Tour";
        const PRESENTER_PASSWORD = "Rbotla123";

        // Function to generate a unique session ID
        function generateSessionId() {
            return 'session-' + Math.random().toString(36).substr(2, 9);
        }

        // Function to create a new session
        function createSession() {
            const newSessionId = generateSessionId();
            const sessionData = {
                active: true,
                currentSlide: 0,
                lastUpdated: new Date().getTime(),
                contentFile: contentFileName
            };
            localStorage.setItem('presentation-session-' + newSessionId, JSON.stringify(sessionData));
            return newSessionId;
        }

        // Function to update session data
        function updateSession(slideIndex) {
            if (sessionId) {
                const sessionData = {
                    active: true,
                    currentSlide: slideIndex,
                    lastUpdated: new Date().getTime(),
                    contentFile: contentFileName
                };
                localStorage.setItem('presentation-session-' + sessionId, JSON.stringify(sessionData));
            }
        }

        // Function to get session data
        function getSessionData(sid) {
            const data = localStorage.getItem('presentation-session-' + sid);
            return data ? JSON.parse(data) : null;
        }

        // Function to end a session
        function endSession() {
            if (sessionId) {
                localStorage.removeItem('presentation-session-' + sessionId);
            }
        }

        // Default content file name, can be overridden
        let contentFileName = "temples.json";

        // Function to load presentation data
        async function loadPresentationData(fileName) {
            try {
                const response = await fetch(fileName);
                if (!response.ok) {
                    throw new Error(`Failed to load data: ${response.status}`);
                }
                const data = await response.json();
                presentationData = data;
                
                // Update page title
                presentationTitle = data.title || "Presentation Tour";
                document.getElementById('presentation-title').textContent = presentationTitle;
                document.title = presentationTitle;
                
                return data;
            } catch (error) {
                console.error("Error loading presentation data:", error);
                alert("Failed to load presentation data. Please check if the content file exists and is correctly formatted.");
                return null;
            }
        }

        // Function to show a slide
        function showSlide(index) {
            if (!presentationData || !presentationData.slides || presentationData.slides.length === 0) {
                return '<div class="presentation-display"><p>No presentation data available</p></div>';
            }

            const slide = presentationData.slides[index];
            
            // Handle multiple images if available
            let imageHTML = '';
            if (Array.isArray(slide.images) && slide.images.length > 0) {
                // If multiple images, show the current one based on some logic
                // For simplicity, we'll just show the first image here
                imageHTML = `<img src="${slide.images[0]}" alt="${slide.title}" class="slide-image">`;
            } else if (slide.image) {
                // Single image
                imageHTML = `<img src="${slide.image}" alt="${slide.title}" class="slide-image">`;
            }

            const slideHTML = `
                <div class="presentation-display">
                    ${imageHTML}
                    <div class="slide-title">${slide.title || ''}</div>
                    <div class="slide-subtitle">${slide.subtitle || ''}</div>
                    <div class="slide-description">${slide.description || ''}</div>
                    ${slide.keyFacts && slide.keyFacts.length > 0 ? `
                        <div class="key-facts">
                            <h3>${slide.factsTitle || 'Key Facts'}</h3>
                            <ul>
                                ${slide.keyFacts.map(fact => `<li>${fact}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
            return slideHTML;
        }

        // Function to show the presenter interface
        async function showPresenterInterface() {
            if (!sessionId) {
                sessionId = createSession();
            }

            const baseUrl = window.location.href.split('?')[0];
            const viewerUrl = `${baseUrl}?session=${sessionId}&direct=true`;

            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="presenter-bar">
                    <h2 style="margin: 0;">Presenter Mode</h2>
                    <div>Session ID: <strong>${sessionId}</strong></div>
                </div>

                <div class="file-selector">
                    <p>Current content file: <strong id="current-file-name">${contentFileName}</strong></p>
                    <div class="form-group">
                        <label for="content-file-input">Change content file:</label>
                        <input type="text" id="content-file-input" placeholder="Enter JSON file name" value="${contentFileName}">
                        <button id="load-content-btn" class="btn">Load Content</button>
                    </div>
                </div>

                <div class="share-section">
                    <h3>Share With Your Audience</h3>
                    <p><strong>Direct Link:</strong></p>
                    <input type="text" id="share-url" value="${viewerUrl}" readonly>
                    <button id="copy-url-btn" class="btn">Copy Link</button>

                    <p><strong>Session ID:</strong></p>
                    <input type="text" id="share-id" value="${sessionId}" readonly>
                    <button id="copy-id-btn" class="btn">Copy ID</button>

                    <div id="qrcode" style="margin: 15px auto; text-align: center;"></div>
                </div>

                <div id="slide-container">Loading slide...</div>

                <div class="controls">
                    <button id="prev-btn" class="btn" ${currentSlideIndex === 0 ? 'disabled' : ''}>⬅️ Previous</button>
                    <div style="align-self: center;">
                        <span id="slide-counter">${currentSlideIndex + 1}</span> of <span id="total-slides">...</span>
                    </div>
                    <button id="next-btn" class="btn">Next ➡️</button>
                </div>

                <button id="end-session-btn" class="btn" style="background-color: #d9534f; width: 100%; margin-top: 20px;">End Session</button>
            `;

            // Load presentation data
            await loadPresentationData(contentFileName);
            
            // Update slide display
            document.getElementById('slide-container').innerHTML = showSlide(currentSlideIndex);
            document.getElementById('total-slides').textContent = presentationData.slides.length;
            
            // Generate QR code
            new QRCode(document.getElementById("qrcode"), {
                text: viewerUrl,
                width: 128,
                height: 128
            });

            // Add event listeners
            document.getElementById('copy-url-btn').addEventListener('click', function() {
                const input = document.getElementById('share-url');
                input.select();
                document.execCommand('copy');
                this.textContent = 'Copied!';
                setTimeout(() => {
                    this.textContent = 'Copy Link';
                }, 2000);
            });

            document.getElementById('copy-id-btn').addEventListener('click', function() {
                const input = document.getElementById('share-id');
                input.select();
                document.execCommand('copy');
                this.textContent = 'Copied!';
                setTimeout(() => {
                    this.textContent = 'Copy ID';
                }, 2000);
            });

            document.getElementById('load-content-btn').addEventListener('click', async function() {
                const newFileName = document.getElementById('content-file-input').value.trim();
                if (newFileName) {
                    contentFileName = newFileName;
                    document.getElementById('current-file-name').textContent = contentFileName;
                    await loadPresentationData(contentFileName);
                    currentSlideIndex = 0;
                    navigateToSlide(0);
                    // Update session data with new content file
                    updateSession(currentSlideIndex);
                } else {
                    alert("Please enter a valid file name");
                }
            });

            document.getElementById('prev-btn').addEventListener('click', function() {
                if (currentSlideIndex > 0) {
                    currentSlideIndex--;
                    navigateToSlide(currentSlideIndex);
                }
            });

            document.getElementById('next-btn').addEventListener('click', function() {
                if (presentationData && presentationData.slides && currentSlideIndex < presentationData.slides.length - 1) {
                    currentSlideIndex++;
                    navigateToSlide(currentSlideIndex);
                }
            });

            document.getElementById('end-session-btn').addEventListener('click', function() {
                if (confirm('Are you sure you want to end this presentation session?')) {
                    endSession();
                    window.location.href = baseUrl;
                }
            });
        }

        // Function to show the viewer interface
        async function showViewerInterface() {
            // Get session data to find out which content file to load
            const sessionData = getSessionData(sessionId);
            if (sessionData && sessionData.contentFile) {
                contentFileName = sessionData.contentFile;
            }
            
            // Load presentation data
            await loadPresentationData(contentFileName);
            
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div id="slide-container">${showSlide(currentSlideIndex)}</div>
                <div style="text-align: center; margin-top: 20px;">
                    Slide <span id="slide-counter">${currentSlideIndex + 1}</span> of ${presentationData.slides.length}
                </div>
            `;
        }

        // Function to navigate to a specific slide
        function navigateToSlide(index) {
            currentSlideIndex = index;
            
            if (isPresenterMode) {
                // Update for presenter
                document.getElementById('slide-container').innerHTML = showSlide(index);
                document.getElementById('slide-counter').textContent = index + 1;
                
                document.getElementById('prev-btn').disabled = index === 0;
                document.getElementById('next-btn').disabled = 
                    !presentationData || !presentationData.slides || 
                    index >= presentationData.slides.length - 1;
                
                // Update session data
                updateSession(index);
            } else {
                // Update for viewer
                document.getElementById('slide-container').innerHTML = showSlide(index);
                document.getElementById('slide-counter').textContent = index + 1;
            }
        }

        // Function to show the waiting screen
        function showWaitingScreen() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="waiting-screen">
                    <h2>Connecting to presentation...</h2>
                    <p class="animated-dots">Waiting for presenter</p>
                    <p>Session ID: ${sessionId}</p>
                </div>
            `;
        }

        // Function to show the login screen
        function showLoginScreen() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="login-container">
                    <div class="form-group">
                        <label for="content-file-select">Presentation Content:</label>
                        <input type="text" id="content-file-select" placeholder="Enter JSON file name" value="${contentFileName}">
                    </div>
                    
                    <button id="presenter-btn" class="btn" style="margin-bottom: 30px; width: 100%;">Start as Presenter</button>
                    
                    <h3>Join Existing Presentation</h3>
                    <div class="form-group">
                        <input type="text" id="session-input" placeholder="Enter session ID">
                        <button id="join-btn" class="btn" style="width: 100%;">Join Session</button>
                    </div>
                </div>
            `;

            // Add event listeners
            document.getElementById('presenter-btn').addEventListener('click', function() {
                const selectedFile = document.getElementById('content-file-select').value.trim();
                if (selectedFile) {
                    contentFileName = selectedFile;
                }
                
                const password = prompt("Enter presenter password:");
                if (password === PRESENTER_PASSWORD) {
                    isPresenterMode = true;
                    sessionId = createSession();
                    window.location.href = `${window.location.href.split('?')[0]}?presenter=${password}&session=${sessionId}&content=${encodeURIComponent(contentFileName)}`;
                } else {
                    alert("Incorrect password");
                }
            });

            document.getElementById('join-btn').addEventListener('click', function() {
                const sid = document.getElementById('session-input').value.trim();
                if (sid) {
                    window.location.href = `${window.location.href.split('?')[0]}?session=${sid}&direct=true`;
                } else {
                    alert("Please enter a session ID");
                }
            });

            document.getElementById('session-input').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('join-btn').click();
                }
            });
        }

        // Function to start polling for updates as a viewer
        function startPolling() {
            const pollInterval = setInterval(() => {
                const sessionData = getSessionData(sessionId);
                
                if (!sessionData) {
                    // Session doesn't exist yet
                    return;
                }
                
                if (!sessionData.active) {
                    // Session ended
                    clearInterval(pollInterval);
                    const contentArea = document.getElementById('content-area');
                    contentArea.innerHTML = `
                        <div class="waiting-screen">
                            <h2>Session Ended</h2>
                            <p>The presenter has ended this presentation session.</p>
                            <button id="home-btn" class="btn">Return to Home</button>
                        </div>
                    `;
                    document.getElementById('home-btn').addEventListener('click', function() {
                        window.location.href = window.location.href.split('?')[0];
                    });
                    return;
                }
                
                // Check if content file has changed
                if (sessionData.contentFile && sessionData.contentFile !== contentFileName) {
                    contentFileName = sessionData.contentFile;
                    // Reload presentation data and update view
                    loadPresentationData(contentFileName).then(() => {
                        currentSlideIndex = sessionData.currentSlide;
                        showViewerInterface();
                    });
                    return;
                }
                
                // Update current slide if changed
                if (sessionData.currentSlide !== currentSlideIndex) {
                    currentSlideIndex = sessionData.currentSlide;
                    if (document.getElementById('slide-container')) {
                        document.getElementById('slide-container').innerHTML = showSlide(currentSlideIndex);
                        document.getElementById('slide-counter').textContent = currentSlideIndex + 1;
                    } else {
                        showViewerInterface();
                    }
                }
            }, 1000);
        }

        // Initialize the application
        async function initApp() {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionParam = urlParams.get('session');
            const presenterParam = urlParams.get('presenter');
            const contentParam = urlParams.get('content');
            
            // Override content file if specified in URL
            if (contentParam) {
                contentFileName = decodeURIComponent(contentParam);
            }

            if (presenterParam === PRESENTER_PASSWORD && sessionParam) {
                // Presenter mode with existing session
                isPresenterMode = true;
                sessionId = sessionParam;
                await showPresenterInterface();
                return;
            }

            if (sessionParam) {
                // Viewer mode
                sessionId = sessionParam;
                const sessionData = getSessionData(sessionId);
                
                if (sessionData && sessionData.contentFile) {
                    contentFileName = sessionData.contentFile;
                }
                
                if (sessionData && sessionData.active) {
                    // Session exists and is active
                    currentSlideIndex = sessionData.currentSlide;
                    await showViewerInterface();
                    startPolling();
                } else {
                    // Session doesn't exist yet or is not active
                    showWaitingScreen();
                    startPolling();
                }
                return;
            }

            // Show login screen by default
            showLoginScreen();
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
