<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Interactive Presentation</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            -webkit-text-size-adjust: 100%;
        }
        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 10px;
            box-sizing: border-box;
        }
        h1, h2, h3 {
            color: #8b4513;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        .presentation-display {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .slide-image {
            width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .slide-title {
            font-size: 1.4rem;
            color: #8b4513;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .slide-subtitle {
            font-style: italic;
            color: #666;
            margin-bottom: 10px;
        }
        .slide-description {
            line-height: 1.6;
        }
        .key-facts {
            background-color: #f9f5eb;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            padding: 12px;
            background: #f0f0f0;
            border-radius: 8px;
        }
        .btn {
            background-color: #8b4513;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .btn:hover {
            background-color: #6d370f;
        }
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .login-container {
            width: 100%;
            max-width: 400px;
            margin: 60px auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            text-align: center;
            box-sizing: border-box;
        }
        .waiting-screen {
            text-align: center;
            padding: 30px 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-top: 40px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            margin-bottom: 10px;
            box-sizing: border-box;
            -webkit-appearance: none;
        }
        .presenter-bar {
            background-color: #8b4513;
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .share-section {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border: 1px solid #ddd;
        }
        .file-selector {
            margin: 15px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .animated-dots::after {
            content: '.';
            animation: dots 1.5s infinite;
        }
        @keyframes dots {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
        /* Mobile-specific adjustments */
        @media (max-width: 600px) {
            .container {
                padding: 8px;
            }
            h1 {
                font-size: 1.5rem;
                margin-bottom: 15px;
            }
            .btn {
                padding: 12px 16px;
                font-size: 0.95rem;
                min-height: 44px; /* Ensure easy tapping on mobile */
            }
            .controls {
                padding: 10px;
            }
            .presentation-display {
                padding: 12px;
            }
            .slide-title {
                font-size: 1.2rem;
            }
            input {
                font-size: 16px; /* Prevent zoom on iOS */
            }
        }
        #debug-info {
            margin-top: 20px;
            padding: 10px;
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container" id="container">
        <h1 id="presentation-title">Presentation Tour</h1>
        <div id="content-area">
            <!-- Content will be populated by JavaScript -->
        </div>
        <div id="debug-info"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        // Application variables
        let currentSlideIndex = 0;
        let isPresenterMode = false;
        let sessionId = null;
        let presentationData = null;
        let presentationTitle = "Presentation Tour";
        const PRESENTER_PASSWORD = "Rbotla123";
        let debugMode = false; // Set to true to see debug information

        // Cross-browser storage utilities
        const storageManager = {
            // Check if storage is available
            isAvailable: function() {
                try {
                    localStorage.setItem('test', 'test');
                    localStorage.removeItem('test');
                    return true;
                } catch (e) {
                    return false;
                }
            },
            
            // Get item with fallback
            get: function(key) {
                try {
                    return localStorage.getItem(key);
                } catch (e) {
                    this.logError('Error getting from storage', e);
                    return null;
                }
            },
            
            // Set item with fallback
            set: function(key, value) {
                try {
                    localStorage.setItem(key, value);
                    return true;
                } catch (e) {
                    this.logError('Error saving to storage', e);
                    return false;
                }
            },
            
            // Remove item with fallback
            remove: function(key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (e) {
                    this.logError('Error removing from storage', e);
                    return false;
                }
            },
            
            // Log errors if in debug mode
            logError: function(message, error) {
                if (debugMode) {
                    console.error(message, error);
                    appendDebugInfo(message + ': ' + error.message);
                }
            }
        };

        // Cross-browser URL utilities
        const urlManager = {
            // Get current page URL without query params
            getBaseUrl: function() {
                return window.location.href.split('?')[0];
            },
            
            // Get full URL with params
            buildUrl: function(params) {
                const baseUrl = this.getBaseUrl();
                const queryString = Object.keys(params)
                    .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(params[key]))
                    .join('&');
                return baseUrl + (queryString ? '?' + queryString : '');
            },
            
            // Get URL parameters
            getParams: function() {
                const params = {};
                try {
                    const queryString = window.location.search.slice(1);
                    if (queryString) {
                        queryString.split('&').forEach(pair => {
                            const [key, value] = pair.split('=');
                            params[decodeURIComponent(key)] = decodeURIComponent(value || '');
                        });
                    }
                } catch (e) {
                    appendDebugInfo('Error parsing URL parameters: ' + e.message);
                }
                return params;
            }
        };

        // Debug helper
        function appendDebugInfo(message) {
            if (debugMode) {
                const debugElement = document.getElementById('debug-info');
                if (debugElement) {
                    debugElement.style.display = 'block';
                    const timestamp = new Date().toLocaleTimeString();
                    debugElement.innerHTML += `<div>[${timestamp}] ${message}</div>`;
                }
            }
        }

        // Function to enable debug mode via URL param
        function checkDebugMode() {
            const params = urlManager.getParams();
            if (params.debug === 'true') {
                debugMode = true;
                document.getElementById('debug-info').style.display = 'block';
                appendDebugInfo('Debug mode enabled');
            }
        }

        // Function to generate a unique session ID
        function generateSessionId() {
            return 'session-' + Math.random().toString(36).substr(2, 9);
        }

        // Function to get session data
        function getSessionData(sid) {
            try {
                const data = storageManager.get('presentation-session-' + sid);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                appendDebugInfo("Error parsing session data: " + error.message);
                return null;
            }
        }

        // Function to create a new session
        function createSession() {
            const newSessionId = generateSessionId();
            const sessionData = {
                active: true,
                currentSlide: 0,
                lastUpdated: new Date().getTime(),
                contentFile: contentFileName
            };
            
            if (storageManager.set('presentation-session-' + newSessionId, JSON.stringify(sessionData))) {
                appendDebugInfo("New session created: " + newSessionId);
            } else {
                appendDebugInfo("Warning: Created session ID but couldn't save to storage");
            }
            
            return newSessionId;
        }

        // Function to update session data
        function updateSession(slideIndex) {
            if (sessionId) {
                const sessionData = {
                    active: true,
                    currentSlide: slideIndex,
                    lastUpdated: new Date().getTime(),
                    contentFile: contentFileName
                };
                
                if (storageManager.set('presentation-session-' + sessionId, JSON.stringify(sessionData))) {
                    appendDebugInfo("Session updated: slide " + slideIndex);
                } else {
                    appendDebugInfo("Warning: Failed to update session");
                }
            }
        }

        // Function to end a session
        function endSession() {
            if (sessionId) {
                if (storageManager.remove('presentation-session-' + sessionId)) {
                    appendDebugInfo("Session ended: " + sessionId);
                } else {
                    appendDebugInfo("Warning: Failed to end session");
                }
            }
        }

        // Default content file name, can be overridden
        let contentFileName = "presentation-content.json";

        // Function to load presentation data
        async function loadPresentationData(fileName) {
            try {
                appendDebugInfo("Loading content from: " + fileName);
                
                const response = await fetch(fileName);
                if (!response.ok) {
                    throw new Error(`Failed to load data: ${response.status}`);
                }
                
                const data = await response.json();
                presentationData = data;
                
                // Update page title
                presentationTitle = data.title || "Presentation Tour";
                document.getElementById('presentation-title').textContent = presentationTitle;
                document.title = presentationTitle;
                
                appendDebugInfo("Content loaded successfully");
                return data;
            } catch (error) {
                appendDebugInfo("Error loading content: " + error.message);
                
                // Show user-friendly error message
                alert("Could not load presentation content. Please check if the file exists and is correctly formatted.");
                return null;
            }
        }

        // Function to show a slide
        function showSlide(index) {
            if (!presentationData || !presentationData.slides || presentationData.slides.length === 0) {
                return '<div class="presentation-display"><p>No presentation data available</p></div>';
            }

            const slide = presentationData.slides[index];
            
            // Handle multiple images if available
            let imageHTML = '';
            if (Array.isArray(slide.images) && slide.images.length > 0) {
                // If multiple images, show the current one based on some logic
                // For simplicity, we'll just show the first image here
                imageHTML = `<img src="${slide.images[0]}" alt="${slide.title || 'Slide image'}" class="slide-image">`;
            } else if (slide.image) {
                // Single image
                imageHTML = `<img src="${slide.image}" alt="${slide.title || 'Slide image'}" class="slide-image">`;
            }

            const slideHTML = `
                <div class="presentation-display">
                    ${imageHTML}
                    <div class="slide-title">${slide.title || ''}</div>
                    <div class="slide-subtitle">${slide.subtitle || ''}</div>
                    <div class="slide-description">${slide.description || ''}</div>
                    ${slide.keyFacts && slide.keyFacts.length > 0 ? `
                        <div class="key-facts">
                            <h3>${slide.factsTitle || 'Key Facts'}</h3>
                            <ul>
                                ${slide.keyFacts.map(fact => `<li>${fact}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
            return slideHTML;
        }

        // Function to show the presenter interface
        async function showPresenterInterface() {
            if (!sessionId) {
                sessionId = createSession();
            }

            const baseUrl = urlManager.getBaseUrl();
            const viewerUrl = urlManager.buildUrl({
                session: sessionId,
                direct: 'true'
            });

            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="presenter-bar">
                    <h2 style="margin: 0;">Presenter Mode</h2>
                    <div>Session ID: <strong>${sessionId}</strong></div>
                </div>

                <div class="file-selector">
                    <h3>Presentation Content</h3>
                    <p>Current content file: <strong id="current-file-name">${contentFileName}</strong></p>
                    <div class="form-group">
                        <label for="content-file-input">Change content file:</label>
                        <input type="text" id="content-file-input" placeholder="Enter JSON file name" value="${contentFileName}">
                        <button id="load-content-btn" class="btn">Load Content</button>
                    </div>
                </div>

                <div class="share-section">
                    <h3>Share With Your Audience</h3>
                    <p><strong>Direct Link:</strong></p>
                    <input type="text" id="share-url" value="${viewerUrl}" readonly>
                    <button id="copy-url-btn" class="btn">Copy Link</button>

                    <p><strong>Session ID:</strong></p>
                    <input type="text" id="share-id" value="${sessionId}" readonly>
                    <button id="copy-id-btn" class="btn">Copy ID</button>

                    <div id="qrcode" style="margin: 15px auto; text-align: center;"></div>
                </div>

                <div id="slide-container">Loading slide...</div>

                <div class="controls">
                    <button id="prev-btn" class="btn" ${currentSlideIndex === 0 ? 'disabled' : ''}>⬅️ Previous</button>
                    <div style="align-self: center;">
                        <span id="slide-counter">${currentSlideIndex + 1}</span> of <span id="total-slides">...</span>
                    </div>
                    <button id="next-btn" class="btn">Next ➡️</button>
                </div>

                <button id="end-session-btn" class="btn" style="background-color: #d9534f; width: 100%; margin-top: 20px;">End Session</button>
            `;

            // Load presentation data
            await loadPresentationData(contentFileName);
            
            // Update slide display
            if (presentationData && presentationData.slides) {
                document.getElementById('slide-container').innerHTML = showSlide(currentSlideIndex);
                document.getElementById('total-slides').textContent = presentationData.slides.length;
            } else {
                document.getElementById('slide-container').innerHTML = '<div class="presentation-display"><p>Failed to load presentation data</p></div>';
                document.getElementById('total-slides').textContent = '0';
            }
            
            // Generate QR code
            try {
                new QRCode(document.getElementById("qrcode"), {
                    text: viewerUrl,
                    width: 128,
                    height: 128
                });
            } catch (e) {
                appendDebugInfo("Error generating QR code: " + e.message);
                document.getElementById("qrcode").innerHTML = '<p>QR code generation failed</p>';
            }

            // Add event listeners
            document.getElementById('copy-url-btn').addEventListener('click', function() {
                copyToClipboard('share-url', this);
            });

            document.getElementById('copy-id-btn').addEventListener('click', function() {
                copyToClipboard('share-id', this);
            });

            document.getElementById('load-content-btn').addEventListener('click', async function() {
                const newFileName = document.getElementById('content-file-input').value.trim();
                if (newFileName) {
                    contentFileName = newFileName;
                    document.getElementById('current-file-name').textContent = contentFileName;
                    await loadPresentationData(contentFileName);
                    currentSlideIndex = 0;
                    navigateToSlide(0);
                    // Update session data with new content file
                    updateSession(currentSlideIndex);
                } else {
                    alert("Please enter a valid file name");
                }
            });

            document.getElementById('prev-btn').addEventListener('click', function() {
                if (currentSlideIndex > 0) {
                    currentSlideIndex--;
                    navigateToSlide(currentSlideIndex);
                }
            });

            document.getElementById('next-btn').addEventListener('click', function() {
                if (presentationData && presentationData.slides && currentSlideIndex < presentationData.slides.length - 1) {
                    currentSlideIndex++;
                    navigateToSlide(currentSlideIndex);
                }
            });

            document.getElementById('end-session-btn').addEventListener('click', function() {
                if (confirm('Are you sure you want to end this presentation session?')) {
                    endSession();
                    window.location.href = baseUrl;
                }
            });
        }

        // Helper function for copying to clipboard
        function copyToClipboard(elementId, buttonElement) {
            const input = document.getElementById(elementId);
            
            // Select the text differently based on device
            if (navigator.userAgent.match(/ipad|iphone/i)) {
                // iOS devices
                const range = document.createRange();
                range.selectNodeContents(input);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                input.setSelectionRange(0, 999999);
            } else {
                // Other devices
                input.select();
            }
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    buttonElement.textContent = 'Copied!';
                    setTimeout(() => {
                        buttonElement.textContent = elementId.includes('url') ? 'Copy Link' : 'Copy ID';
                    }, 2000);
                } else {
                    throw new Error('Copy command failed');
                }
            } catch (err) {
                appendDebugInfo('Copy failed: ' + err.message);
                alert('Copy failed. Please copy manually.');
            }
        }

        // Function to show the viewer interface
        async function showViewerInterface() {
            // Get session data to find out which content file to load
            const sessionData = getSessionData(sessionId);
            if (sessionData && sessionData.contentFile) {
                contentFileName = sessionData.contentFile;
                appendDebugInfo("Using content file from session: " + contentFileName);
            }
            
            // Load presentation data
            await loadPresentationData(contentFileName);
            
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div id="slide-container">${showSlide(currentSlideIndex)}</div>
                <div style="text-align: center; margin: 20px 0;">
                    Slide <span id="slide-counter">${currentSlideIndex + 1}</span> of 
                    ${presentationData && presentationData.slides ? presentationData.slides.length : '?'}
                </div>
                
                <div class="controls" style="justify-content: center; margin-top: 20px;">
                    <button id="refresh-view-btn" class="btn">Refresh View</button>
                </div>
            `;
            
            // Add refresh button functionality
            document.getElementById('refresh-view-btn').addEventListener('click', function() {
                const currentData = getSessionData(sessionId);
                if (currentData) {
                    if (currentData.contentFile !== contentFileName) {
                        contentFileName = currentData.contentFile;
                        loadPresentationData(contentFileName).then(() => {
                            currentSlideIndex = currentData.currentSlide;
                            navigateToSlide(currentSlideIndex);
                        });
                    } else if (currentData.currentSlide !== currentSlideIndex) {
                        currentSlideIndex = currentData.currentSlide;
                        navigateToSlide(currentSlideIndex);
                    } else {
                        // Just refresh the current view
                        document.getElementById('slide-container').innerHTML = showSlide(currentSlideIndex);
                    }
                    appendDebugInfo("View refreshed manually");
                }
            });
        }

        // Function to navigate to a specific slide
        function navigateToSlide(index) {
            currentSlideIndex = index;
            
            if (isPresenterMode) {
                // Update for presenter
                document.getElementById('slide-container').innerHTML = showSlide(index);
                document.getElementById('slide-counter').textContent = index + 1;
                
                document.getElementById('prev-btn').disabled = index === 0;
                document.getElementById('next-btn').disabled = 
                    !presentationData || !presentationData.slides || 
                    index >= presentationData.slides.length - 1;
                
                // Update session data
                updateSession(index);
            } else {
                // Update for viewer
                document.getElementById('slide-container').innerHTML = showSlide(index);
                document.getElementById('slide-counter').textContent = index + 1;
            }
        }

        // Function to show the waiting screen
        function showWaitingScreen() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="waiting-screen">
                    <h2>Connecting to presentation...</h2>
                    <p class="animated-dots">Waiting for presenter</p>
                    <p>Session ID: ${sessionId}</p>
                    <p style="margin-top: 20px;">Having trouble connecting?</p>
                    <button id="refresh-connection-btn" class="btn">Refresh Connection</button>
                    <button id="home-btn" class="btn" style="margin-top: 10px; background-color: #555;">Return Home</button>
                </div>
            `;
            
            // Add button functionality
            setTimeout(() => {
                const refreshBtn = document.getElementById('refresh-connection-btn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', function() {
                        const directUrl = urlManager.buildUrl({
                            session: sessionId,
                            direct: 'true',
                            nocache: new Date().getTime()
                        });
                        window.location.href = directUrl;
                    });
                }
                
                const homeBtn = document.getElementById('home-btn');
                if (homeBtn) {
                    homeBtn.addEventListener('click', function() {
                        window.location.href = urlManager.getBaseUrl();
                    });
                }
            }, 100);
        }

        // Function to show the login screen
        function showLoginScreen() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="login-container">
                    <div class="form-group">
                        <label for="content-file-select">Presentation Content:</label>
                        <input type="text" id="content-file-select" placeholder="Enter JSON file name" value="${contentFileName}">
                    </div>
                    
                    <button id="presenter-btn" class="btn" style="margin-bottom: 30px; width: 100%;">Start as Presenter</button>
                    
                    <h3>Join Existing Presentation</h3>
                    <div class="form-group">
                        <input type="text" id="session-input" placeholder="Enter session ID">
                        <button id="join-btn" class="btn" style="width: 100%;">Join Session</button>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button id="debug-toggle-btn" class="btn" style="background-color: #555; font-size: 0.8rem; padding: 8px;">Toggle Debug Info</button>
                    </div>
                </div>
            `;

            // Add event listeners
            document.getElementById('presenter-btn').addEventListener('click', function() {
                const selectedFile = document.getElementById('content-file-select').value.trim();
                if (selectedFile) {
                    contentFileName = selectedFile;
                }
                
                const password = prompt("Enter presenter password:");
                if (password === PRESENTER_PASSWORD) {
                    isPresenterMode = true;
                    sessionId = createSession();
                    
                    // Add debug parameter if in debug mode
                    const params = {
                        presenter: password,
                        session: sessionId,
                        content: contentFileName
                    };
                    
                    if (debugMode) {
                        params.debug = 'true';
                    }
                    
                    window.location.href = urlManager.buildUrl(params);
                } else {
                    alert("Incorrect password");
                }
            });

            document.getElementById('join-btn').addEventListener('click', function() {
                const sid = document.getElementById('session-input').value.trim();
                if (sid) {
                    const params = {
                        session: sid,
                        direct: 'true'
                    };
                    
                    if (debugMode) {
                        params.debug = 'true';
                    }
                    
                    window.location.href = urlManager.buildUrl(params);
                } else {
                    alert("Please enter a session ID");
                }
            });

            document.getElementById('session-input').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('join-btn').click();
                }
            });
            
            document.getElementById('debug-toggle-btn').addEventListener('click', function() {
                debugMode = !debugMode;
                document.getElementById('debug-info').style.display = debugMode ? 'block' : 'none';
                appendDebugInfo("Debug mode " + (debugMode ? "enabled" : "disabled"));
            });
        }

        // Function to start polling for updates as a viewer
        function startPolling() {
            // First, try to load immediately to avoid waiting
            const sessionData = getSessionData(sessionId);
            if (sessionData && sessionData.active) {
                // Session exists and is active
                currentSlideIndex = sessionData.currentSlide;
                if (document.getElementById('slide-container')) {
                    document.getElementById('slide-container').innerHTML = showSlide(currentSlideIndex);
                    document.getElementById('slide-counter').textContent = currentSlideIndex + 1;
                } else {
                    showViewerInterface();
                }
            }
            
            // Mobile-friendly polling - decreased frequency to save battery
            const pollInterval = setInterval(() => {
                const sessionData = getSessionData(sessionId);
                
                if (!sessionData) {
                    // Session doesn't exist
                    appendDebugInfo("No session data found for: " + sessionId);
                    
                    // Update waiting screen
                    const waitingScreen = document.querySelector('.waiting-screen');
                    if (waitingScreen) {
                        waitingScreen.innerHTML = `
                            <h2>Connection Issue</h2>
                            <p>Unable to find the presentation session.</p>
                            <p>Session ID: ${sessionId}</p>
                            <button id="retry-btn" class="btn">Retry Connection</button>
                            <button id="return-home-btn" class="btn" style="background-color: #555; margin-top: 10px;">Return Home</button>
                        `;
                        
                        // Add button functionality
                        document.getElementById('retry-btn').addEventListener('click', function() {
                            const directUrl = urlManager.buildUrl({
                                session: sessionId,
                                direct: 'true',
                                nocache: new Date().getTime()
                            });
                            window.location.href = directUrl;
                        });
                        
                        document.getElementById('return-home-btn').addEventListener('click', function() {
                            window.location.href = urlManager.getBaseUrl();
                        });
                    }
                    return;
                }
                
                if (!sessionData.active) {
                    // Session ended
                    clearInterval(pollInterval);
                    appendDebugInfo("Session has ended: " + sessionId);
                    
                    const contentArea = document.getElementById('content-area');
                    contentArea.innerHTML = `
                        <div class="waiting-screen">
                            <h2>Session Ended</h2>
                            <p>The presenter has ended this presentation session.</p>
                            <button id="home-btn" class="btn">Return to Home</button>
                        </div>
                    `;
                    
                    document.getElementById('home-btn').addEventListener('click', function() {
                        window.location.href = urlManager.getBaseUrl();
                    });
                    return;
                }
                
                // Check if content file has changed
                if (sessionData.contentFile && sessionData.contentFile !== contentFileName) {
                    appendDebugInfo("Content file changed: " + sessionData.contentFile);
                    contentFileName = sessionData.contentFile;
                    
                    // Reload presentation data and update view
                    loadPresentationData(contentFileName).then(() => {
                        currentSlideIndex = sessionData.currentSlide;
                        if (document.getElementById('slide-container')) {
                            document.getElementById('slide-container').innerHTML = showSlide(currentSlideIndex);
                            document.getElementById('slide-counter').textContent = currentSlideIndex + 1;
                        } else {
                            showViewerInterface();
                        }
                    });
                    return;
                }
                
                // Update current slide if changed
                if (sessionData.currentSlide !== currentSlideIndex) {
                    appendDebugInfo("Slide changed: " + sessionData.currentSlide);
                    currentSlideIndex = sessionData.currentSlide;
                    
                    if (document.getElementById('slide-container')) {
                        document.getElementById('slide-container').innerHTML = showSlide(currentSlideIndex);
                        document.getElementById('slide-counter').textContent = currentSlideIndex + 1;
                    } else {
                        showViewerInterface();
                    }
                }
            }, 2000); // Poll every 2 seconds instead of 1
        }

        // Initialize the application
        async function initApp() {
            checkDebugMode();
            appendDebugInfo("App initialization started");
            
            const urlParams = urlManager.getParams();
            const sessionParam = urlParams.session;
            const presenterParam = urlParams.presenter;
            const contentParam = urlParams.content;
            const directParam = urlParams.direct;
            
            appendDebugInfo("URL parameters: " + JSON.stringify(urlParams));
            
            // Override content file if specified in URL
            if (contentParam) {
                contentFileName = contentParam;
                appendDebugInfo("Content file from URL: " + contentFileName);
            }

            if (presenterParam === PRESENTER_PASSWORD && sessionParam) {
                // Presenter mode with existing session
                appendDebugInfo("Starting presenter mode with session: " + sessionParam);
                isPresenterMode = true;
                sessionId = sessionParam;
                await showPresenterInterface();
                return;
            }

            if (sessionParam) {
                // Viewer mode
                sessionId = sessionParam;
                appendDebugInfo("Starting viewer mode with session: " + sessionId);
                
                // Try to get session data first
                const sessionData = getSessionData(sessionId);
                
                if (sessionData && sessionData.contentFile) {
                    contentFileName = sessionData.contentFile;
                    appendDebugInfo("Content file from session: " + contentFileName);
                }
                
                if (sessionData && sessionData.active) {
                    // Session exists and is active
                    appendDebugInfo("Session is active, current slide: " + sessionData.currentSlide);
                    currentSlideIndex = sessionData.currentSlide;
                    await showViewerInterface();
                    startPolling();
                } else {
                    // Session doesn't exist yet or is not active
                    appendDebugInfo("Session not found or not active, showing waiting screen");
                    showWaitingScreen();
                    startPolling();
                    
                    // Add a manual timeout for mobile devices to avoid indefinite waiting
                    setTimeout(() => {
                        const waitingScreen = document.querySelector('.waiting-screen');
                        if (waitingScreen) {
                            const sessionData = getSessionData(sessionId);
                            if (!sessionData || !sessionData.active) {
                                waitingScreen.innerHTML = `
                                    <h2>No Active Presentation Found</h2>
                                    <p>Could not connect to presentation after waiting.</p>
                                    <p>Session ID: ${sessionId}</p>
                                    <button id="retry-btn" class="btn">Try Again</button>
                                    <button id="home-btn" class="btn" style="background-color: #555; margin-top: 10px;">Return Home</button>
                                `;
                                
                                document.getElementById('retry-btn').addEventListener('click', function() {
                                    const directUrl = urlManager.buildUrl({
                                        session: sessionId,
                                        direct: 'true',
                                        nocache: new Date().getTime()
                                    });
                                    window.location.href = directUrl;
                                });
                                
                                document.getElementById('home-btn').addEventListener('click', function() {
                                    window.location.href = urlManager.getBaseUrl();
                                });
                            }
                        }
                    }, 10000); // Show timeout message after 10 seconds
                }
                return;
            }

            // Show login screen by default
            appendDebugInfo("No session or presenter parameters, showing login screen");
            showLoginScreen();
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', initApp);
        
        // Handle mobile-specific events
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible' && !isPresenterMode && sessionId) {
                // On mobile, when user returns to the tab/app after it was in background
                appendDebugInfo("Page visibility changed to visible - refreshing data");
                
                const sessionData = getSessionData(sessionId);
                if (sessionData && sessionData.active) {
                    if (sessionData.currentSlide !== currentSlideIndex) {
                        currentSlideIndex = sessionData.currentSlide;
                        if (document.getElementById('slide-container')) {
                            document.getElementById('slide-container').innerHTML = showSlide(currentSlideIndex);
                            document.getElementById('slide-counter').textContent = currentSlideIndex + 1;
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
